rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Plans collection
    match /plans/{planId} {
      // Allow read if:
      // 1. User is a member of the plan, OR
      // 2. Plan has an inviteCode (allows joining via invite links)
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.members ||
        resource.data.inviteCode != null
      );

      // Allow create if user is authenticated
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.createdBy &&
        request.auth.uid in request.resource.data.members;

      // Allow update if:
      // 1. User is admin or a member, OR
      // 2. User is joining via invite (adding themselves to members)
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.admin ||
        request.auth.uid in resource.data.members ||
        (
          // User is joining via invite
          resource.data.inviteCode != null &&
          request.auth.uid in request.resource.data.members &&
          !(request.auth.uid in resource.data.members)
        )
      );

      // Allow delete only if user is admin
      allow delete: if request.auth != null &&
        request.auth.uid == resource.data.admin;
    }

    // Activities (tasks) collection
    match /activities/{activityId} {
      // Allow read if user is a member of the associated plan
      allow read: if request.auth != null;

      // Allow create if user is authenticated
      allow create: if request.auth != null;

      // Allow update if user is authenticated
      allow update: if request.auth != null;

      // Allow delete if user is authenticated
      allow delete: if request.auth != null;
    }

    // Expenses collection
    match /expenses/{expenseId} {
      // Allow read if user is authenticated
      allow read: if request.auth != null;

      // Allow create if user is authenticated
      allow create: if request.auth != null;

      // Allow update if user is authenticated
      allow update: if request.auth != null;

      // Allow delete if user is authenticated
      allow delete: if request.auth != null;
    }

    // Users collection
    match /users/{userId} {
      // Allow users to read any profile
      allow read: if request.auth != null;

      // Allow users to create/update only their own profile
      allow create, update: if request.auth != null && request.auth.uid == userId;

      // Allow users to delete only their own profile
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
  }
}
